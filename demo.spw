## ğŸŒ¼ Parser Playground
# A minimal yet exhaustive demo for regression testing.

^app { parser_playground {

  # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  #  Constants ğŸ”¢
  *TICK_MS        : int!   = 1_000
  *HEX_MASK       : int!   = 0xBE_EF
  *TARGET_TEMP    : float! = 37.5<Â°C>
  *EARTH_RADIUS   : float! = 6_371<km>

  # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  #  Types ğŸ“
  ^type { Metric {
    name  : string!,
    value : float!<unit>,
    ts    : datetime!
  } }

  ^type { Command {
    kind : string!,
    arg  : string!
  } }

  # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  #  Channels ğŸ“¡
  <chan[Metric]>  metric_bus
  <chan[Command]> command_bus
  <chan[string]>  log_bus

  # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  #  Flows ğŸŒŠ
  ~flow { bootstrap {
    log("ğŸ bootstrappingâ€¦")
    ~fiber { ticker }
    ~fiber { echo }
  } }

  ~flow { ticker {
    ~let mut *i : int! = 0
    ~loop {
      *metric : Metric = &{
        name: "tick",
        value: *i<cnt>,
        ts: now()
      }
      metric_bus!> *metric
      *i = *i + 1
      sleep_ms(*TICK_MS)
    }
  } }

  ~flow { echo {
    ~loop {
      ?<&metric_bus => (m : Metric)
      log(f"ğŸ”” {m.name} â†’ {m.value}")
      if (m.value % 5 == 0)? {
        command_bus!> &{ kind: "milestone", arg: str(m.value) }
      }
    }
  } }

  # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  #  Macros âœï¸
  #macro { log { &msg : string! {
    log_bus!> f"[{now()}] {&msg}"
  } } }

  # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  #  CLI View ğŸ–¥ï¸
  @view { cli {
    .render {
      <io>::out("ğŸŒ³ Playground active â€” press Ctrl-C to quit\n")
      ~for msg in log_bus { <io>::out(f"{msg}\n") }
    }
  } }
} }

# EOF
